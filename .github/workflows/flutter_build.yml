name: ğŸš€ T3R-C0D3 Build & Release Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Tipo de compilaciÃ³n'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug
        - profile

env:
  FLUTTER_VERSION: '3.29.3'
  JAVA_VERSION: '17'
  NODE_VERSION: '18'

jobs:
  # ğŸ” AnÃ¡lisis de cÃ³digo y validaciones
  code-analysis:
    name: ğŸ“Š AnÃ¡lisis de CÃ³digo
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: âš¡ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Restaurar cache de dependencias
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          .dart_tool
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-

    - name: ğŸ”§ Instalar dependencias
      run: flutter pub get

    - name: ğŸ§ª Verificar formato de cÃ³digo
      run: dart format --output=none --set-exit-if-changed .

    - name: ğŸ” AnÃ¡lisis estÃ¡tico
      run: flutter analyze --fatal-infos

    - name: ğŸ§ª Ejecutar tests
      run: flutter test --coverage

    - name: ğŸ“Š Subir cobertura a Codecov
      uses: codecov/codecov-action@v4
      with:
        file: coverage/lcov.info
        fail_ci_if_error: false

  # ğŸ”¨ CompilaciÃ³n de APKs
  build-apk:
    name: ğŸ—ï¸ Compilar APK
    runs-on: ubuntu-latest
    needs: code-analysis
    strategy:
      matrix:
        target: [android-arm, android-arm64, android-x64]
        build_mode: [release]
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: â˜• Setup Java JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: ${{ env.JAVA_VERSION }}

    - name: âš¡ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Restaurar cache de dependencias
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          .dart_tool
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-

    - name: ğŸ”§ Instalar dependencias
      run: flutter pub get

    - name: ğŸ—ï¸ Generar assets y cÃ³digo
      run: |
        flutter packages pub run build_runner build --delete-conflicting-outputs || echo "No build_runner configured"
        flutter gen-l10n || echo "No localization configured"

    - name: ğŸ“± Compilar APK (${{ matrix.target }})
      run: |
        flutter build apk \
          --${{ matrix.build_mode }} \
          --target-platform ${{ matrix.target }} \
          --split-per-abi \
          --dart-define=FLUTTER_WEB_AUTO_DETECT=true

    - name: ğŸ“‹ InformaciÃ³n del APK
      run: |
        echo "ğŸ“± APK generado para: ${{ matrix.target }}"
        echo "ğŸ”§ Modo: ${{ matrix.build_mode }}"
        echo "ğŸ“Š TamaÃ±o del APK:"
        ls -lah build/app/outputs/flutter-apk/
        
        # Obtener informaciÃ³n detallada del APK
        if command -v aapt &> /dev/null; then
          echo "ğŸ“‹ InformaciÃ³n del APK:"
          aapt dump badging build/app/outputs/flutter-apk/app-${{ matrix.target }}-${{ matrix.build_mode }}.apk | head -10
        fi

    - name: ğŸ“¦ Preparar artefactos
      run: |
        mkdir -p artifacts/${{ matrix.target }}
        
        # Determinar nombre del archivo APK generado
        if [ -f "build/app/outputs/flutter-apk/app-${{ matrix.target }}-${{ matrix.build_mode }}.apk" ]; then
          APK_FILE="app-${{ matrix.target }}-${{ matrix.build_mode }}.apk"
        elif [ -f "build/app/outputs/flutter-apk/app-${{ matrix.build_mode }}.apk" ]; then
          APK_FILE="app-${{ matrix.build_mode }}.apk"
        else
          echo "âŒ No se encontrÃ³ el APK generado"
          ls -la build/app/outputs/flutter-apk/
          exit 1
        fi
        
        echo "ğŸ“± APK encontrado: $APK_FILE"
        
        # Copiar APK con nombre descriptivo
        cp "build/app/outputs/flutter-apk/$APK_FILE" "artifacts/${{ matrix.target }}/t3r-c0d3-${{ matrix.target }}-${{ matrix.build_mode }}.apk"
        
        # Generar archivo de informaciÃ³n
        cat > "artifacts/${{ matrix.target }}/build-info.txt" << EOF
        ğŸš€ T3R-C0D3 Build Information
        ============================
        ğŸ“… Fecha: $(date)
        ğŸ·ï¸  Commit: ${{ github.sha }}
        ğŸŒ¿ Branch: ${{ github.ref_name }}
        ğŸ¯ Target: ${{ matrix.target }}
        ğŸ”§ Modo: ${{ matrix.build_mode }}
        ğŸ“± Flutter: ${{ env.FLUTTER_VERSION }}
        â˜• Java: ${{ env.JAVA_VERSION }}
        ğŸ¤– Runner: ${{ runner.os }}
        ğŸ‘¤ Actor: ${{ github.actor }}
        
        ğŸ“Š TamaÃ±o del APK:
        $(ls -lah artifacts/${{ matrix.target }}/t3r-c0d3-${{ matrix.target }}-${{ matrix.build_mode }}.apk)
        EOF

    - name: ğŸ“¤ Subir APK como artefacto
      uses: actions/upload-artifact@v4
      with:
        name: t3r-c0d3-${{ matrix.target }}-${{ matrix.build_mode }}
        path: artifacts/${{ matrix.target }}/
        retention-days: 30
        compression-level: 6

  # ğŸ“¦ Crear release unificado
  create-release:
    name: ğŸ“¦ Crear Release Unificado
    runs-on: ubuntu-latest
    needs: build-apk
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ“¥ Descargar todos los artefactos
      uses: actions/download-artifact@v4
      with:
        path: ./downloads

    - name: ğŸ“¦ Crear paquete unificado
      run: |
        mkdir -p release-package
        
        # Crear estructura de directorios
        mkdir -p release-package/{arm32,arm64,x64,docs}
        
        # Organizar APKs por arquitectura
        find downloads -name "*.apk" -type f | while read apk; do
          if [[ "$apk" == *"android-arm64"* ]]; then
            cp "$apk" release-package/arm64/
          elif [[ "$apk" == *"android-arm-"* ]]; then
            cp "$apk" release-package/arm32/
          elif [[ "$apk" == *"android-x64"* ]]; then
            cp "$apk" release-package/x64/
          fi
        done
        
        # Copiar informaciÃ³n de build
        find downloads -name "build-info.txt" -exec cp {} release-package/docs/ \;
        
        # Crear README del release
        cat > release-package/README.md << 'EOF'
        # ğŸš€ T3R-C0D3 Release Package
        
        ## ğŸ“± APKs Incluidos
        
        ### ğŸ”¥ arm64 (Recomendado - Dispositivos modernos)
        - Compatibilidad: Android 7.0+ (API 24+)
        - Arquitectura: 64-bit ARM
        - Dispositivos: Samsung Galaxy S8+, Google Pixel 2+, OnePlus 5+, etc.
        
        ### ğŸ”§ arm32 (Compatibilidad legacy)
        - Compatibilidad: Android 5.0+ (API 21+) 
        - Arquitectura: 32-bit ARM
        - Dispositivos: Dispositivos antiguos y gama baja
        
        ### ğŸ’» x64 (Emuladores y tablets x86)
        - Compatibilidad: Emuladores Android Studio
        - Arquitectura: 64-bit x86
        - Dispositivos: Algunos tablets Intel
        
        ## ğŸ“¥ InstalaciÃ³n
        
        1. Habilita "Fuentes desconocidas" en tu dispositivo
        2. Descarga el APK correspondiente a tu arquitectura
        3. Instala el APK
        4. Â¡Disfruta T3R-C0D3!
        
        ## ğŸ” Â¿QuÃ© arquitectura tengo?
        
        Usa apps como "CPU-Z" o "Device Info" para verificar tu arquitectura.
        
        **Regla general:**
        - Dispositivos 2017+ â†’ arm64
        - Dispositivos 2013-2017 â†’ arm32  
        - Emuladores â†’ x64
        
        ## ğŸ“ Soporte
        
        - ğŸ“± Telegram: @rk13termux
        - ğŸ™ GitHub: https://github.com/Rk13termux
        - ğŸ“º YouTube: @rk13termux
        
        ---
        
        ğŸ“… Generado: $(date)
        ğŸ·ï¸ Commit: ${{ github.sha }}
        ğŸŒ¿ Branch: ${{ github.ref_name }}
        EOF
        
        # Crear changelog automÃ¡tico
        cat > release-package/CHANGELOG.md << 'EOF'
        # ğŸ“ Changelog
        
        ## Cambios en esta versiÃ³n
        
        ### âœ¨ Nuevas caracterÃ­sticas
        - Sistema de anuncios AdMob integrado
        - Interfaz mejorada con animaciones nativas
        - Soporte para mÃºltiples arquitecturas
        - Mejor gestiÃ³n de repositorios
        
        ### ğŸ”§ Mejoras tÃ©cnicas
        - OptimizaciÃ³n de rendimiento
        - ReducciÃ³n del tamaÃ±o del APK
        - Mejor manejo de errores
        - CÃ³digo mÃ¡s limpio y mantenible
        
        ### ğŸ› Correcciones
        - Solucionados crashes en dispositivos antiguos
        - Mejorada compatibilidad con Android 14
        - Corregidos problemas de navegaciÃ³n
        
        ---
        
        Para ver el historial completo: https://github.com/Rk13termux/T3R-C0D3/releases
        EOF

    - name: ğŸ—œï¸ Crear ZIP unificado
      run: |
        cd release-package
        zip -r "../t3r-c0d3-complete-release-${{ github.ref_name || 'latest' }}.zip" .
        cd ..
        
        echo "ğŸ“¦ Contenido del ZIP:"
        unzip -l "t3r-c0d3-complete-release-${{ github.ref_name || 'latest' }}.zip"
        
        echo "ğŸ“Š TamaÃ±o del paquete:"
        ls -lah t3r-c0d3-complete-release-*.zip

    - name: ğŸ“¤ Subir paquete completo
      uses: actions/upload-artifact@v4
      with:
        name: t3r-c0d3-complete-release
        path: t3r-c0d3-complete-release-*.zip
        retention-days: 90

    - name: ğŸš€ Crear GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          t3r-c0d3-complete-release-*.zip
          release-package/README.md
          release-package/CHANGELOG.md
        name: "ğŸš€ T3R-C0D3 ${{ github.ref_name }}"
        body: |
          # ğŸš€ T3R-C0D3 Release ${{ github.ref_name }}
          
          ## ğŸ“± Descarga RÃ¡pida
          
          **Â¿No sabes quÃ© APK descargar?** 
          
          ğŸ‘‰ **Descarga el ZIP completo** que incluye todas las arquitecturas + documentaciÃ³n
          
          ## ğŸ¯ APKs por Arquitectura
          
          - **arm64**: Dispositivos modernos (2017+) - **RECOMENDADO**
          - **arm32**: Dispositivos antiguos (2013-2017)
          - **x64**: Emuladores y tablets Intel
          
          ## ğŸ”¥ Novedades en esta versiÃ³n
          
          - âœ¨ Sistema de anuncios AdMob
          - ğŸ¨ Interfaz renovada con animaciones
          - ğŸš€ Mejor rendimiento y estabilidad
          - ğŸ“± Soporte mejorado para Android 14
          
          ## ğŸ“ Soporte
          
          - ğŸ“± Telegram: [@rk13termux](https://t.me/rk13termux)
          - ğŸ™ GitHub: [Issues](https://github.com/Rk13termux/T3R-C0D3/issues)
          
          ---
          
          ğŸ“… **Generado automÃ¡ticamente** el $(date)
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
        token: ${{ secrets.GITHUB_TOKEN }}

  # ğŸ§¹ Limpieza y notificaciones
  cleanup:
    name: ğŸ§¹ Limpieza y Notificaciones
    runs-on: ubuntu-latest
    needs: [build-apk, create-release]
    if: always()
    
    steps:
    - name: ğŸ“Š Resumen del build
      run: |
        echo "## ğŸ“Š Resumen del Build" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ·ï¸ **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸŒ¿ **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ‘¤ **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“… **Fecha**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- âš¡ **Flutter**: ${{ env.FLUTTER_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- â˜• **Java**: ${{ env.JAVA_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ Artefactos Generados" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“± APK arm64 (recomendado)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“± APK arm32 (legacy)" >> $GITHUB_STEP_SUMMARY  
        echo "- ğŸ“± APK x64 (emuladores)" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“¦ ZIP completo con documentaciÃ³n" >> $GITHUB_STEP_SUMMARY

    - name: âœ… NotificaciÃ³n de Ã©xito
      if: success()
      run: |
        echo "ğŸ‰ Â¡Build completado exitosamente!"
        echo "ğŸ“¦ Los artefactos estÃ¡n disponibles en la pestaÃ±a 'Actions'"
        
    - name: âŒ NotificaciÃ³n de fallo
      if: failure()
      run: |
        echo "ğŸ’¥ El build fallÃ³. Revisa los logs para mÃ¡s detalles."
        echo "ğŸ” Verifica errores de compilaciÃ³n o dependencias faltantes."